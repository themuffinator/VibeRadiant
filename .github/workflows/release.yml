name: release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  windows-msys:
    name: Windows ${{ matrix.arch }}
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        arch: [x86_64]
        include:
          - arch: x86_64
            msystem: MINGW64
            prefix: mingw-w64-x86_64

    defaults:
      run:
        shell: msys2 {0}

    steps:
    - uses: msys2/setup-msys2@v2
      with:
        install: base-devel ${{ matrix.prefix }}-toolchain ${{ matrix.prefix }}-qt6-base ${{ matrix.prefix }}-qt6-svg ${{ matrix.prefix }}-qt6-multimedia ${{ matrix.prefix }}-assimp ${{ matrix.prefix }}-libxml2 git unzip p7zip
        msystem: ${{ matrix.msystem }}
        path-type: minimal
        release: false
        update: false

    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build
      run: |
        make MAKEFILE_CONF=msys2-Makefile.conf -j4
        mkdir -p install/settings
        7z a VibeRadiant-windows-${{ matrix.arch }}.zip ./install/*

    - uses: actions/upload-artifact@v4
      with:
        name: windows-${{ matrix.arch }}
        path: VibeRadiant-windows-${{ matrix.arch }}.zip
        if-no-files-found: error

  linux:
    name: Linux x86_64
    runs-on: ubuntu-latest
    steps:
    - name: Install tools
      run: |
          sudo apt-get -qq update
          sudo apt-get -y install mesa-common-dev qt6-base-dev qt6-svg-dev qt6-multimedia-dev libglib2.0-dev libjpeg-dev libpng-dev libassimp-dev
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build
      run: |
        make CC=gcc-14 CXX=g++-14 CXXFLAGS="-Wno-deprecated-copy" -j4
        ./appimage.sh

    - uses: actions/upload-artifact@v4
      with:
        name: linux-x86_64
        path: VibeRadiant-x86_64.AppImage
        if-no-files-found: error

  macos:
    name: macOS arm64
    runs-on: macos-14
    steps:
    - name: Install tools
      shell: bash
      run: |
        brew update
        brew install qt@6 pkg-config glib libxml2 libpng jpeg-turbo assimp mesa libx11

    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Build
      shell: bash
      run: |
        BREW_PREFIX="$(brew --prefix)"
        QT_PREFIX="$(brew --prefix qt@6)"
        export PATH="$QT_PREFIX/bin:$BREW_PREFIX/bin:$PATH"
        export PKG_CONFIG_PATH="$QT_PREFIX/lib/pkgconfig:$BREW_PREFIX/lib/pkgconfig"
        make OS=Darwin MACLIBDIR="$BREW_PREFIX/lib" LIBS_GL="-lGL -lX11" LIBS_DL= -j4
        tar -C install -czf VibeRadiant-macos-arm64.tar.gz .

    - uses: actions/upload-artifact@v4
      with:
        name: macos-arm64
        path: VibeRadiant-macos-arm64.tar.gz
        if-no-files-found: error

  release:
    name: Publish release
    needs: [windows-msys, linux, macos]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Verify version
      run: |
        VERSION=$(cat VERSION)
        TAG="${GITHUB_REF_NAME#v}"
        if [ "$VERSION" != "$TAG" ]; then
          echo "VERSION file ($VERSION) does not match tag ($TAG)." >&2
          exit 1
        fi
        echo "VERSION=$VERSION" >> $GITHUB_ENV

    - uses: actions/download-artifact@v4

    - name: Prepare assets
      run: |
        mkdir -p release
        mv windows-x86_64/VibeRadiant-windows-x86_64.zip release/VibeRadiant-${VERSION}-windows-x86_64.zip
        mv linux-x86_64/VibeRadiant-x86_64.AppImage release/VibeRadiant-${VERSION}-linux-x86_64.AppImage
        mv macos-arm64/VibeRadiant-macos-arm64.tar.gz release/VibeRadiant-${VERSION}-macos-arm64.tar.gz
        python - <<'PY'
        import datetime
        import hashlib
        import json
        import os
        import pathlib

        version = os.environ["VERSION"]
        tag = os.environ["GITHUB_REF_NAME"]
        repo = os.environ["GITHUB_REPOSITORY"]
        base_url = f"https://github.com/{repo}/releases/download/{tag}"

        def file_info(path, asset_type):
            data = pathlib.Path(path).read_bytes()
            sha = hashlib.sha256(data).hexdigest()
            size = len(data)
            name = pathlib.Path(path).name
            return {
                "url": f"{base_url}/{name}",
                "sha256": sha,
                "name": name,
                "type": asset_type,
                "size": size,
            }

        assets = {
            "windows-x86_64": file_info(f"release/VibeRadiant-{version}-windows-x86_64.zip", "zip"),
            "linux-x86_64": file_info(f"release/VibeRadiant-{version}-linux-x86_64.AppImage", "appimage"),
            "macos-arm64": file_info(f"release/VibeRadiant-{version}-macos-arm64.tar.gz", "tar.gz"),
        }

        manifest = {
            "version": version,
            "notes": f"https://github.com/{repo}/releases/tag/{tag}",
            "published_at": datetime.datetime.utcnow().replace(microsecond=0).isoformat() + "Z",
            "assets": assets,
        }

        with open("release/update.json", "w", encoding="utf-8") as f:
            json.dump(manifest, f, indent=2, sort_keys=True)
        PY

    - name: Checksums
      run: |
        (cd release && sha256sum * > sha256sums.txt)

    - name: Publish release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          release/*
        generate_release_notes: true
